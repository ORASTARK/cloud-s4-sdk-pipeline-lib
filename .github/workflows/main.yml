name: Test on Kubernetes

on: [push]

jobs:
  test-on-k8s:
    runs-on: ubuntu-18.04
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v1.0.0
        with:
          minikube version: 'v1.5.2'
          kubernetes version: 'v1.16.2'
      - uses: azure/setup-helm@v1
        id: install
      - name: Setup Project Piper Jenkins master
        run: |
          helm init
          helm repo add stable https://kubernetes-charts.storage.googleapis.com/
          helm repo update
          helm install --generate-name stable/jenkins -f values.yaml
          export POD_NAME=$(kubectl get pods --namespace default -l "app.kubernetes.io/component=jenkins-master" -o jsonpath="{.items[0].metadata.name}")
          kubectl --namespace default port-forward $POD_NAME 8080:8080
          export HOST=${POD_NAME}:8080
          docker run -v //var/run/docker.sock:/var/run/docker.sock -v $(pwd):/workspace -e CASC_JENKINS_CONFIG=/workspace/jenkins.yml -e HOST ppiper/jenkinsfile-runner
